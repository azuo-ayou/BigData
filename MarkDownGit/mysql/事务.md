### 事务四大特性

ACID

1. 原子性：要么成功，要么失败，不会有中间态
2. 一致性：转账来说，不管转几次最终总金额是不变的
3. 隔离性：两个事务操作互相不干扰，不依赖
4. 持久性：天崩地裂，数据不会回滚



### 事务的四种隔离级别

**Read uncommitted（读未提交）**：

问题：读到别人未提交的数据

**Read committed（读已提交）**：

解决：别人没有提交的数据是不可能读取到的

问题：再一次事务A中，需要两次查询同一条数据，第一次查完，事务B修改了数据，并且提交了事务B，然后事务A再次查询，发现在同一次事务A中，两次查询的数据是不一样的。

**Repeatable read（可重复读）**：（会导致幻读现象）

解决：给数据加锁，当查询数据的时候别人不允许修改（更新）这条数据，那我这次事务中我不管查几次，数据都是一样的

问题（幻读）：我虽然给这条数据加锁了，不能修改这条数据，但是另一个事务C，在表中插入了相同条件的另一条数据。那么也是显示的不一样

**Serializable**：串行化，可以避免以上现象



mysql默认的隔离级别是第三级：Repeatable read



### 快照读和当前读

**幻读**：一个事务同样的查询条件，两次查询到的数据行数不一样，它就产生了幻读



**快照读**：在MySQL中，查询语句分为两种，一种是简单的select操作，属于快照读，不加锁。它读的是记录的快照版本。

**防止幻读**：通过MVCC来防止幻读

**快照读的幻读**：可以更新或者删除，不能插入某一条数据

是的，MySQL没有完全解决快照读下的幻读问题。

可以做这个实验：

1. 当前DB已有id 5, 10, 15三条数据。
2. 事务A查询id < 10的数据，可以查出一行记录id = 5
3. 事务B插入id = 6的数据
4. 事务A再查询id < 10的数据，可以查出一行记录id = 5，查不出id = 6的数据（读场景，解决了幻读）
5. 事务A可以更新/删除id = 6的数据，不能插入id = 6的数据（写场景，幻读不彻底）



这个很好理解，MySQL虽然通过MVCC的版本号来解决了读场景下的幻读，但对于上面第5步那种写场景的情况，其实是无能为力的，因为MVCC毕竟是无锁实现。

所以如果后续要对数据进行写操作，还是**通过for update语句上锁**比较稳妥，不然就可能会出现上面第5步那样的问题。



**当前读**：另一种是要加锁的特殊的读操作，它读的是记录的最新版本。

**防止幻读**：通过gap lock（间隙锁）来防止幻读

**当前读的幻读**：当前读下的幻读是通过间隙锁（gap_lock)来实现的。在事务A查询的时候，会锁住一个间隙，其它事务往这个间隙插入、删除等操作都是会被锁阻塞的。



参考文献：[大佬对幻读的理解](https://zhuanlan.zhihu.com/p/382010436#:~:text=MySQL%20InnoDB%E9%BB%98%E8%AE%A4%E7%9A%84%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E6%98%AFRepeatable%20Reads%EF%BC%88RR%EF%BC%89%EF%BC%8C%E4%BD%86%E5%AE%83%E9%80%9A%E8%BF%87MVCC%2B%E9%97%B4%E9%9A%99%E9%94%81%E8%A7%A3%E5%86%B3%E4%BA%86,%E7%BB%9D%E5%A4%A7%E9%83%A8%E5%88%86%20%E5%B9%BB%E8%AF%BB%EF%BC%88%E5%90%8E%E9%9D%A2%E4%BC%9A%E8%A7%A3%E9%87%8A%E4%B8%BA%E4%BB%80%E4%B9%88%E6%98%AF%E7%BB%9D%E5%A4%A7%E9%83%A8%E5%88%86%E8%80%8C%E4%B8%8D%E6%98%AF%E5%85%A8%E9%83%A8%EF%BC%89%E7%9A%84%E9%97%AE%E9%A2%98%E3%80%82%20%E7%AE%80%E5%8D%95%E6%9D%A5%E8%AF%B4%EF%BC%8C%E4%B8%80%E4%B8%AA%E4%BA%8B%E5%8A%A1%E5%90%8C%E6%A0%B7%E7%9A%84%E6%9F%A5%E8%AF%A2%E6%9D%A1%E4%BB%B6%EF%BC%8C%E4%B8%A4%E6%AC%A1%E6%9F%A5%E8%AF%A2%E5%88%B0%E7%9A%84%E6%95%B0%E6%8D%AE%E8%A1%8C%E6%95%B0%E4%B8%8D%E4%B8%80%E6%A0%B7%EF%BC%8C%E5%AE%83%E5%B0%B1%E4%BA%A7%E7%94%9F%E4%BA%86%E5%B9%BB%E8%AF%BB%E3%80%82)